#!/bin/zsh

# GitHub CLI account switcher with git config
# Requires: gh (GitHub CLI), fzf

# ログイン済みのGitHubアカウントを取得
accounts=($(gh auth status 2>&1 | grep "Logged in" | sed -n 's/.*account \([^ ]*\) .*/\1/p'))

# アカウントが取得できているか確認
if [ ${#accounts[@]} -eq 0 ]; then
    echo "No GitHub accounts found. Make sure you're logged in to GitHub CLI."
    echo "Run: gh auth login"
    exit 1
fi

# fzfでアカウントを選択
selected_account=$(printf '%s\n' "${accounts[@]}" | fzf --prompt="Select GitHub account to switch to: " --height=20% --border)

# 選択されたアカウントに切り替え
if [[ -n "$selected_account" ]]; then
    gh auth switch -u "$selected_account"
    echo "Switched GitHub CLI to: $selected_account"

    # SSH鍵を切り替え
    case "$selected_account" in
        "nitakan")
            cp ~/.ssh/id_rsa_nitakan ~/.ssh/id_rsa_current
            cp ~/.ssh/id_rsa_nitakan.pub ~/.ssh/id_rsa_current.pub
            echo "Switched SSH key to: nitakan"
            ;;
        "yzrh-mkato")
            cp ~/.ssh/id_rsa_yzrh ~/.ssh/id_rsa_current
            cp ~/.ssh/id_rsa_yzrh.pub ~/.ssh/id_rsa_current.pub
            echo "Switched SSH key to: yzrh-mkato (yzrh)"
            ;;
    esac

    # git author を切り替え
    user_json=$(gh api /user 2>/dev/null)
    if [[ $? -ne 0 || -z "$user_json" ]]; then
        echo "Warning: Could not retrieve user info from GitHub API"
    else
        git_name=$(echo "$user_json" | jq -r '.name // .login')

        # メール取得: user/emails API → /user .email → noreply フォールバック
        git_email=$(gh api user/emails --jq '[.[] | select(.primary)] | .[0].email' 2>/dev/null)

        if [[ -z "$git_email" || "$git_email" == *"{"* ]]; then
            # user/emails が失敗した場合、/user の .email を試す
            git_email=$(echo "$user_json" | jq -r '.email // empty')
        fi

        if [[ -z "$git_email" || "$git_email" == *"{"* ]]; then
            # それでも取得できない場合、noreply メールを生成
            user_id=$(echo "$user_json" | jq -r '.id')
            user_login=$(echo "$user_json" | jq -r '.login')
            git_email="${user_id}+${user_login}@users.noreply.github.com"
        fi

        if [[ -n "$git_name" && -n "$git_email" ]]; then
            git config --global user.name "$git_name"
            git config --global user.email "$git_email"
            echo "Switched git author to: $git_name <$git_email>"
        else
            echo "Warning: Could not determine git author info"
        fi
    fi
fi
