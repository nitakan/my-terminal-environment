#!/bin/bash
set -euo pipefail

# 定数
CREATE_NEW="+ 新規作成"

# git リポジトリ内かチェック
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# worktree 一覧を取得（gwq list --json → jq でパース）
worktrees=$(gwq list --json 2>/dev/null | jq -r '.[].branch' || echo "")

# fzf 用リストを作成（先頭に「+ 新規作成」を追加）
fzf_list=$(printf "%s\n%s" "$CREATE_NEW" "$worktrees")

# fzf で選択
selected=$(echo "$fzf_list" | fzf --prompt="Worktree> " --height=100% --reverse || echo "")

# キャンセル時は終了
if [ -z "$selected" ]; then
    exit 0
fi

if [ "$selected" = "$CREATE_NEW" ]; then
    # 新規作成: ブランチ名を入力
    echo -n "新規ブランチ名: "
    read -r branch_name

    if [ -z "$branch_name" ]; then
        echo "キャンセルしました"
        exit 0
    fi

    # gwq add -b で新規 worktree 作成
    if ! gwq add -b "$branch_name"; then
        echo "Error: Failed to create worktree" >&2
        read -r -p "Press Enter to close..."
        exit 1
    fi

    # 作成した worktree のパスを取得
    worktree_path=$(gwq get "$branch_name" 2>/dev/null || echo "")
    # タブ名には新規作成したブランチ名（= worktree名）を使用
    tab_name="$branch_name"
else
    # 既存 worktree: パスを取得
    worktree_path=$(gwq get "$selected" 2>/dev/null || echo "")
    # タブ名には選択したブランチ名（= worktree名）を使用
    tab_name="$selected"
fi

# パスが取得できなかった場合
if [ -z "$worktree_path" ] || [ ! -d "$worktree_path" ]; then
    echo "Error: Worktree path not found" >&2
    read -r -p "Press Enter to close..."
    exit 1
fi

# 新しいタブを IDE レイアウトで開く
zellij action new-tab --layout ide --cwd "$worktree_path" --name "$tab_name"
